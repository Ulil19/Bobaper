{% extends "/user/layout/layoutuser.html" %}

{% block content %}

<!-- Product Start -->
<div class="produk" id="produk">
    <div class="container-xxl py-5">
        <div class="content-container" style="padding-top: 100px;">
            <div class="row g-0 gx-5 align-items-end">
                <div class="col-lg-6">
                    <div class="section-header text-start mb-5 wow fadeInUp" data-wow-delay="0.1s"
                        style="max-width: 500px;">
                        <h1 class="display-5 mb-3">Our Products</h1>
                        <p>Bobapeer.id</p>
                    </div>
                </div>
            </div>
            <div class="tab-content">
                <div id="tab-1" class="tab-pane fade show p-0 active">
                    <div class="row g-4">
                        {% for produk in produk %}
                        <div class="col-xl-3 col-lg-4 col-md-6 wow fadeInUp" data-wow-delay="0.1s">
                            <div class="product-item">
                                <div class="position-relative bg-light overflow-hidden">
                                    <img class="img-fluid w-100"
                                        src="{{ url_for('static', filename='imgproduct/' + produk['foto']) }}" alt="">
                                    <div
                                        class="bg-secondary rounded text-white position-absolute start-0 top-0 m-4 py-1 px-3">
                                        New</div>
                                </div>
                                <div class="text-center p-4">
                                    <a class="d-block h5 mb-2" href="">{{ produk['nama'] }}</a>
                                    <span class="text-primary me-1">Stok: {{ produk['stock'] }}</span><br>
                                    <span class="text-body me-3">Harga: Rp.{{ '{:,.2f}'.format(produk['harga']) }}</span>
                                </div>
                                <div class="d-flex border-top justify-content-center">
                                    <small class="text-center py-2">
                                        <a class="text-body mx-auto add-to-cart" data-id="{{ produk['_id'] }}">
                                            <i class="fa fa-shopping-bag text-primary me-2"></i>Add to cart
                                        </a>
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        <!-- Additional products can be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Product End -->

<!-- Review Section Start -->
<div class="review-section container-xxl py-5" id="reviews">
    <div class="content-container">
        <div class="section-header text-start mb-5 wow fadeInUp" data-wow-delay="0.1s" style="max-width: 500px;">
            <h1 class="display-5 mb-3">Our Review</h1>
            <p>Bobapeer.id</p>
        </div>
        <div id="review-content">
            <!-- Reviews will be loaded here via AJAX -->
        </div>
        <div class="add-review mt-5">
            <div class="d-flex align-items-center">
                <img src="{{ url_for('static', filename='img/images.jpeg') }}" alt="Profile" class="rounded-circle" width="50">
                <input type="text" class="form-control ms-3" id="trigger-review" placeholder="Add your review" readonly>
            </div>
            <form id="review-form" class="mt-3 d-none">
                <div class="mb-3">
                    <label for="review" class="form-label">Review</label>
                    <textarea class="form-control" id="review" rows="3" required></textarea>
                </div>
                <input type="hidden" id="product-id">
                <button type="submit" class="btn btn-primary">Submit Review</button>
                <button type="button" class="btn btn-secondary" id="cancel-review">Cancel</button>
            </form>
        </div>
    </div>
</div>
<!-- Review Section End -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Add to cart button click event
        $(".add-to-cart").click(function (e) {
            e.preventDefault();

            // Get the product ID
            var productId = $(this).data("id");

            // Send an AJAX request to add the product to the shopping cart
            $.ajax({
                url: "/addshoppingcart",
                type: "POST",
                data: {
                    product_id: productId
                },
                success: function (response) {
                    alert("Product added to cart!");
                },
                error: function (xhr, status, error) {
                    alert("An error occurred: " + error);
                }
            });
        });

        // Load all reviews when the page loads
        $.ajax({
            url: "/getallreviews",
            type: "GET",
            success: function (response) {
                // Load reviews into the review section
                $('#review-content').html(response);
            },
            error: function (xhr, status, error) {
                alert("An error occurred while loading reviews: " + error);
            }
        });

        // Show the review form when the "Add your review" input is clicked
        $('#trigger-review').click(function() {
            $(this).addClass('d-none');
            $('#review-form').removeClass('d-none');
        });

        // Hide the review form when the cancel button is clicked
        $('#cancel-review').click(function() {
            $('#review-form')[0].reset();
            $('#review-form').addClass('d-none');
            $('#trigger-review').removeClass('d-none');
        });

        // Review form submit event
        $("#review-form").submit(function (e) {
            e.preventDefault();

            // Get form data
            var formData = {
                username: $("#username").val(),
                review: $("#review").val(),
                product_id: $("#product-id").val()
            };

            // Send an AJAX request to submit the review
            $.ajax({
                url: "/submitreview",
                type: "POST",
                data: formData,
                success: function (response) {
                    alert("Review submitted successfully!");

                    // Clear the form
                    $("#review-form")[0].reset();
                    $('#review-form').addClass('d-none');
                    $('#trigger-review').removeClass('d-none');

                    // Reload reviews
                    $.ajax({
                        url: "/getallreviews",
                        type: "GET",
                        success: function (response) {
                            // Load reviews into the review section
                            $('#review-content').html(response);
                        },
                        error: function (xhr, status, error) {
                            alert("An error occurred while loading reviews: " + error);
                        }
                    });
                },
                error: function (xhr, status, error) {
                    alert("An error occurred while submitting the review: " + error);
                }
            });
        });
    });
</script>
{% endblock %}
